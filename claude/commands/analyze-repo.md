# analyze-repo
リポジトリの処理フローを実装レベルで詳細解析し、Mermaid図を含む技術ドキュメントを生成

## 概要
任意のPython/Rustプロジェクトのメインエントリーポイントから呼び出される全処理フローを実装レベルで解析し、Mermaid図を含む開発者向けの詳細な技術ドキュメントを日本語で生成します。

## 実行内容

### 0. プロジェクト解析
- 現在のディレクトリまたは指定されたディレクトリのプロジェクトを解析
- メインエントリーポイントの自動検出（以下の優先順位）：
  1. `main.py`, `__main__.py`
  2. `setup.py`または`pyproject.toml`に記載されたエントリーポイント
  3. 実行可能な`.py`ファイル（shebangまたは`if __name__ == "__main__"`を持つ）
  4. `src/`ディレクトリ内の主要モジュール
  5. Rustプロジェクトの場合：`Cargo.toml`の`[[bin]]`セクション
- プロジェクトの種類を判定（Python、Rust、混合プロジェクト）

### 1. 実装レベルのコードフロー解析
- エントリポイントから全関数を順次追跡
- 各関数のシグネチャと具体的なコード例を含める
- 実際のパラメータと戻り値を明記
- 番号付きセクションで処理順序を明確化

### 2. 視覚的な図解（Mermaid）の要件

#### 2.1 処理フロー図
- **完全性**: エントリポイントから最終出力まで、すべての主要コンポーネントを網羅
- **階層構造**: subgraphを使用して論理的なグループ（データソース層、処理層、出力層など）を明確化
- **並列処理の可視化**: スレッド、プロセス、並列処理がある場合は明示的に表現
- **データフローの明確化**: 矢印にラベルを付けて、何が流れているかを説明
- **規模**: 実際の処理の複雑さを反映した十分な詳細度（目安：50行以上）

#### 2.2 メモリ/データ変換フロー図  
- **変換過程の段階表示**: データ形式がどのように変換されるかを段階的に表示
- **メモリ階層の表現**: CPU/GPU、異なるメモリ空間を明確に区別
- **サイズ情報**: 可能な限り各段階でのデータサイズや処理単位を併記
- **転送方法の明記**: データがどのように移動するか（DMA、ゼロコピー等）を表示

#### 2.3 Mermaid図の品質基準
- **視覚的区別**: classDef を使用して、異なる種類のコンポーネントを色分け
- **可読性**: 適切な改行とインデントで構造を明確化
- **自己完結性**: 図だけを見ても処理の流れが理解できる
- **メタ情報の活用**: 点線や注釈で補足情報（性能指標、並列度等）を追加

### 3. 関数レベルの処理フロー解析

#### 3.1 メインフローの関数呼び出し階層
エントリポイントから各関数がどのように呼び出されるかを階層的に表示：
```
main.py::main()  # または検出されたエントリーポイント
├── module1.function1() - 機能説明
│   ├── module2.function2() - 機能説明
│   └── module3.function3() - 機能説明
└── module4.function4() - 機能説明
    └── external_process() - 外部プロセス呼び出し
```

#### 3.2 詳細な関数フロー図（フェーズ別）
プロジェクトの性質に応じて、適切なフェーズ分けを行い、各フェーズでの関数呼び出しを可視化

#### 3.3 関数の自動検出と解析方法
- `ast`モジュールを使用した静的解析でエントリポイントから追跡
- import文の解析による依存関係の把握
- 関数シグネチャの抽出（引数、戻り値）
- docstringからの機能説明の抽出
- 型ヒントがある場合はそれも含める

### 4. プロジェクト固有の技術詳細
- 検出されたアーキテクチャパターン（MVC、Producer-Consumer、Pipeline等）の説明
- 並列処理や非同期処理の実装方法
- 特殊なライブラリやフレームワークの使用（Flask、Django、FastAPI、Tokio等）
- プロジェクト固有の設計パターンや規約

### 5. コード例の充実
- 実際の関数呼び出し例（パラメータと戻り値を含む）
- 重要な処理のコード断片
- 環境変数や設定ファイルの使用例
- エラーハンドリングのパターン

### 6. データフローと変換
- データの入力形式から出力形式への変換過程
- 中間データ形式の説明
- データ検証やサニタイゼーションのポイント

### 7. 外部連携
- 外部API、データベース、ファイルシステムとの連携
- プロセス間通信（IPC）の方法
- ネットワーク通信のプロトコルとフォーマット

### 8. markdown構文チェック
- markdownlint-cliエラーを確認して修正
- Mermaid図の構文チェック
- Mermaid図内の特殊文字エスケープ
- ファイル末尾の改行
- 適切なコードブロック終了

## 出力形式
- **出力先**: 現在のディレクトリに`docs/`ディレクトリを作成（なければ）
- **ファイル名**: `docs/repository_analysis_YYYYMMDD_HHMMSS.md`
- **単一ファイル**: Mermaid図を含む包括的なドキュメント
- **実装者向け**: 即座に理解・修正可能な粒度
- **実用的**: コピペ可能なコード例を多数含む
- **視覚的**: プレビュー可能なMermaid図で直感的理解

## 特徴
- リポジトリの種類を自動判定（Python、Rust、混合、その他）
- プロジェクト構造を自動解析
- 関数名・変数名は元の言語のまま（説明は日本語）
- 実際の処理フローに沿った構成
- Mermaid図によるビジュアル解説

## 9. IDEエラーチェックと修正（必須）

### 9.1 Mermaid図のエラーチェック
生成したドキュメントを必ずIDEで開いて、以下のMermaidエラーパターンを徹底的に確認・修正すること：

#### 9.1.1 サブグラフ構文の確認
- **エラーパターン**: `subgraph "名前"` または `subgraph ID[名前]`
- **正しい形式**: `subgraph ID` のみ（角括弧なし、クォートなし）
- **修正例**:
  ```mermaid
  %% 誤り
  subgraph "データソース層"
  subgraph DataSource[データソース層]
  
  %% 正しい
  subgraph DataSource
      direction TB
      %% データソース層
  ```

#### 9.1.2 ノードID内の特殊文字
- **禁止文字**: アンダースコア（_）、スラッシュ（/）、括弧（）、コロン（:）
- **修正方法**: 
  - アンダースコアは削除またはハイフンに変換
  - パスは "in" や "to" で表現
  - 括弧内容はラベルに移動
- **修正例**:
  ```mermaid
  %% 誤り
  /tmp/data_file.txt[Temp File]
  main_function[Main Function]
  api_call()[API Call]
  
  %% 正しい
  tmpfile[Temp File in tmp]
  mainfunction[Main Function]
  apicall[API Call]
  ```

#### 9.1.3 ノードラベル内の特殊文字
- **エスケープが必要な文字**: バックスラッシュ（\）、制御文字
- **配列表記**: `string[]` → `string array`
- **型区切り**: `int/float` → `int or float`
- **修正例**:
  ```mermaid
  %% 誤り
  NODE1[Data: dict[str, Any]]
  NODE2[Path: /home/user/file]
  
  %% 正しい  
  NODE1[Data dict of str to Any]
  NODE2[Path home user file]
  ```

#### 9.1.4 エッジラベルの確認
- **括弧を含むラベル**: 関数呼び出し形式を避ける
- **特殊記号**: できるだけシンプルなテキストに
- **修正例**:
  ```mermaid
  %% 誤り
  A -->|func(param="value")| B
  C -.->|data: List[int]| D
  
  %% 正しい
  A -->|func with param value| B  
  C -.->|data list of int| D
  ```

### 9.2 Markdown構文エラーの確認
- **コードブロックの閉じ忘れ**: 必ず3つのバッククォートで閉じる
- **インデントの統一**: スペース4つで統一
- **空行の確保**: セクション間に適切な空行
- **ファイル末尾**: 必ず改行で終わる

### 9.3 検証手順
1. 生成したファイルをVSCodeなどのIDEで開く
2. Mermaidプレビュー拡張機能で図が正しく表示されるか確認
3. 赤い波線やエラー表示がないか全体をスクロールして確認
4. エラーがあれば上記パターンに従って即座に修正
5. 修正後、再度プレビューで確認

### 9.4 よくあるIDEエラーメッセージと対処法
| エラーメッセージ | 原因 | 対処法 |
|----------------|------|--------|
| `Expecting node ID` | サブグラフに角括弧使用 | 角括弧を削除し、コメントで日本語追加 |
| `Invalid character in node ID` | ノードIDに特殊文字 | アンダースコアや特殊文字を削除 |
| `Unexpected token` | エスケープされていない特殊文字 | ラベル内の特殊文字を簡略化 |
| `Missing closing` | 括弧やクォートの不一致 | 対応する閉じ記号を確認 |

**重要**: これらのチェックを怠ると、IDEでエラーが表示され続けるため、必ず実施すること。